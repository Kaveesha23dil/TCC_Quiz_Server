<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Plagiarism Detection Report</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

    :root {
      --primary: #6c5ce7;
      --danger: #e74c3c;
      --warning: #f39c12;
      --success: #2ecc71;
      --light: #f8f9fa;
      --dark: #2d3436;
      --gray: #dfe6e9;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 2rem;
      color: var(--dark);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    h1 {
      color: var(--primary);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .header-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--light);
      padding: 1.5rem;
      border-radius: 12px;
      text-align: center;
      border-left: 4px solid var(--primary);
    }

    .stat-card.danger {
      border-left-color: var(--danger);
    }

    .stat-card.warning {
      border-left-color: var(--warning);
    }

    .stat-card.success {
      border-left-color: var(--success);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: var(--primary);
    }

    .stat-label {
      font-size: 0.9rem;
      color: #666;
      margin-top: 0.5rem;
    }

    .filter-section {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 0.6rem 1.2rem;
      border: 2px solid var(--gray);
      background: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-family: inherit;
    }

    .filter-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .submissions-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .submissions-table th {
      background: var(--primary);
      color: white;
      padding: 1rem;
      text-align: left;
      font-weight: 600;
    }

    .submissions-table td {
      padding: 1rem;
      border-bottom: 1px solid var(--gray);
    }

    .submissions-table tr:hover {
      background: var(--light);
    }

    .severity-badge {
      display: inline-block;
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .severity-high {
      background: #ffebee;
      color: #c62828;
    }

    .severity-medium {
      background: #fff3e0;
      color: #ef6c00;
    }

    .severity-low {
      background: #fff9c4;
      color: #f57f17;
    }

    .view-details-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
      font-family: inherit;
    }

    .view-details-btn:hover {
      background: #5649c0;
      transform: translateY(-2px);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      overflow-y: auto;
    }

    .modal-content {
      background: white;
      max-width: 900px;
      margin: 2rem auto;
      border-radius: 16px;
      padding: 2rem;
      position: relative;
    }

    .close-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: var(--danger);
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .flag-item {
      background: var(--light);
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      border-left: 4px solid var(--warning);
    }

    .flag-item.high {
      border-left-color: var(--danger);
    }

    .similarity-match {
      background: #fff3cd;
      padding: 1rem;
      border-radius: 8px;
      margin: 0.5rem 0;
      border-left: 4px solid var(--warning);
    }

    .back-btn {
      background: var(--gray);
      color: var(--dark);
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-family: inherit;
      font-size: 1rem;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .back-btn:hover {
      background: #b2bec3;
    }

    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #666;
    }

    .empty-state i {
      font-size: 4rem;
      color: var(--success);
      margin-bottom: 1rem;
    }

    .score-indicator {
      font-weight: bold;
      font-size: 1.2rem;
    }

    .score-high {
      color: var(--danger);
    }

    .score-medium {
      color: var(--warning);
    }

    .score-low {
      color: #f39c12;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-info">
      <div>
        <h1>
          <i class="fas fa-shield-alt"></i>
          Plagiarism Detection Report
        </h1>
        <p id="quiz-name" style="color: #666; margin-top: 0.5rem;"></p>
      </div>
      <button class="back-btn" onclick="window.location.href='admin.html'">
        <i class="fas fa-arrow-left"></i>
        Back to Admin
      </button>
    </div>

    <div class="stats" id="stats-container">
      <div class="stat-card">
        <div class="stat-value" id="total-submissions">0</div>
        <div class="stat-label">Total Submissions</div>
      </div>
      <div class="stat-card danger">
        <div class="stat-value" id="flagged-count">0</div>
        <div class="stat-label">Flagged Submissions</div>
      </div>
      <div class="stat-card warning">
        <div class="stat-value" id="flagged-percentage">0%</div>
        <div class="stat-label">Flagged Rate</div>
      </div>
    </div>

    <div class="filter-section">
      <button class="filter-btn active" onclick="filterSubmissions('all')">All Flagged</button>
      <button class="filter-btn" onclick="filterSubmissions('high')">High Risk</button>
      <button class="filter-btn" onclick="filterSubmissions('medium')">Medium Risk</button>
      <button class="filter-btn" onclick="filterSubmissions('low')">Low Risk</button>
    </div>

    <div id="submissions-container"></div>
  </div>

  <!-- Detail Modal -->
  <div class="modal" id="detail-modal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal()">Ã—</button>
      <div id="modal-content"></div>
    </div>
  </div>

  <script>
    let allSubmissions = [];
    let currentFilter = 'all';

    async function loadReport() {
      try {
        const response = await fetch('/api/plagiarism/report');
        if (!response.ok) throw new Error('Failed to load report');

        const data = await response.json();

        document.getElementById('quiz-name').textContent = `Quiz: ${data.quizName}`;
        document.getElementById('total-submissions').textContent = data.totalSubmissions;
        document.getElementById('flagged-count').textContent = data.flaggedSubmissions;

        const percentage = data.totalSubmissions > 0
          ? Math.round((data.flaggedSubmissions / data.totalSubmissions) * 100)
          : 0;
        document.getElementById('flagged-percentage').textContent = `${percentage}%`;

        allSubmissions = data.submissions;
        renderSubmissions(allSubmissions);
      } catch (error) {
        console.error('Error loading report:', error);
        document.getElementById('submissions-container').innerHTML = `
          <div class="empty-state">
            <i class="fas fa-exclamation-circle"></i>
            <h3>Failed to load plagiarism report</h3>
            <p>Please make sure a quiz is active or has been completed.</p>
          </div>
        `;
      }
    }

    function renderSubmissions(submissions) {
      const container = document.getElementById('submissions-container');

      if (submissions.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-check-circle"></i>
            <h3>No Flagged Submissions</h3>
            <p>All submissions appear legitimate. No plagiarism detected!</p>
          </div>
        `;
        return;
      }

      let html = `
        <table class="submissions-table">
          <thead>
            <tr>
              <th>Student Name</th>
              <th>Suspicion Score</th>
              <th>Score</th>
              <th>Completion Time</th>
              <th>Flags</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
      `;

      submissions.forEach(sub => {
        const analysis = sub.plagiarismAnalysis;
        const severity = getSeverity(analysis.suspicionScore);
        const severityClass = severity.toLowerCase();
        const scoreClass = `score-${severityClass}`;

        html += `
          <tr>
            <td><strong>${sub.participantName}</strong></td>
            <td>
              <span class="score-indicator ${scoreClass}">
                ${analysis.suspicionScore}%
              </span>
            </td>
            <td>${sub.percentage}% (${sub.score}pts)</td>
            <td>${sub.completionTime}s</td>
            <td>
              <span class="severity-badge severity-${severityClass}">
                ${analysis.flags.length} ${severity} Flag(s)
              </span>
            </td>
            <td>
              <button class="view-details-btn" onclick="viewDetails('${sub.participantId}')">
                <i class="fas fa-eye"></i> View Details
              </button>
            </td>
          </tr>
        `;
      });

      html += `
          </tbody>
        </table>
      `;

      container.innerHTML = html;
    }

    function filterSubmissions(filter) {
      currentFilter = filter;

      // Update active button
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      let filtered = allSubmissions;

      if (filter !== 'all') {
        filtered = allSubmissions.filter(sub => {
          const severity = getSeverity(sub.plagiarismAnalysis.suspicionScore).toLowerCase();
          return severity === filter;
        });
      }

      renderSubmissions(filtered);
    }

    function getSeverity(score) {
      if (score >= 80) return 'HIGH';
      if (score >= 60) return 'MEDIUM';
      return 'LOW';
    }

    async function viewDetails(participantId) {
      try {
        const response = await fetch(`/api/plagiarism/submission/${participantId}`);
        if (!response.ok) throw new Error('Failed to load details');

        const data = await response.json();
        renderDetails(data);
        document.getElementById('detail-modal').style.display = 'block';
      } catch (error) {
        console.error('Error loading details:', error);
        alert('Failed to load submission details');
      }
    }

    function renderDetails(data) {
      const analysis = data.plagiarismAnalysis;
      const modalContent = document.getElementById('modal-content');

      let html = `
        <h2><i class="fas fa-user"></i> ${data.participantName}</h2>
        <p style="color: #666; margin-bottom: 2rem;">
          Score: ${data.percentage}% | Completion Time: ${data.completionTime}s
        </p>

        <div style="background: var(--light); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
          <h3 style="color: var(--danger); margin-bottom: 1rem;">
            <i class="fas fa-exclamation-triangle"></i>
            Overall Suspicion Score: ${analysis.suspicionScore}%
          </h3>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
            <div>
              <strong>Answer Similarity:</strong><br>
              <span style="color: var(--primary);">${analysis.scores.answerSimilarity}%</span>
            </div>
            <div>
              <strong>Typing Pattern:</strong><br>
              <span style="color: var(--primary);">${analysis.scores.typingPattern}%</span>
            </div>
            <div>
              <strong>Time Anomaly:</strong><br>
              <span style="color: var(--primary);">${analysis.scores.timeAnomaly}%</span>
            </div>
          </div>
        </div>

        <h3 style="margin-bottom: 1rem;"><i class="fas fa-flag"></i> Detected Issues</h3>
      `;

      analysis.flags.forEach(flag => {
        const severityClass = flag.severity.toLowerCase();
        html += `
          <div class="flag-item ${severityClass}">
            <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 0.5rem;">
              <strong style="color: var(--danger);">
                <i class="fas fa-exclamation-circle"></i> ${flag.type.replace(/_/g, ' ')}
              </strong>
              <span class="severity-badge severity-${severityClass}" style="margin-left: auto;">
                ${flag.severity}
              </span>
            </div>
            <p style="color: #666; margin-bottom: 0.5rem;">${flag.description}</p>
        `;

        if (flag.type === 'ANSWER_SIMILARITY' && flag.details.length > 0) {
          html += '<div style="margin-top: 1rem;">';
          flag.details.forEach(match => {
            html += `
              <div class="similarity-match">
                <strong>Similar to: ${match.participantName}</strong><br>
                Similarity Score: ${match.similarityScore}%<br>
                Matching Questions: ${match.matchingAnswers.length}
              </div>
            `;
          });
          html += '</div>';
        } else if (flag.details && Array.isArray(flag.details)) {
          html += '<ul style="margin-top: 0.5rem; padding-left: 1.5rem; color: #666;">';
          flag.details.forEach(detail => {
            html += `<li>${detail.issue}: ${detail.value} (Expected: ${detail.expected})</li>`;
          });
          html += '</ul>';
        }

        html += '</div>';
      });

      // Typing data summary
      if (data.typingData) {
        html += `
          <h3 style="margin-top: 2rem; margin-bottom: 1rem;">
            <i class="fas fa-keyboard"></i> Typing Pattern Data
          </h3>
          <div style="background: var(--light); padding: 1rem; border-radius: 8px;">
            <p><strong>Average Typing Speed:</strong> ${Math.round(data.typingData.questionTypingSpeeds.reduce((a,b) => a+b, 0) / data.typingData.questionTypingSpeeds.length)} WPM</p>
            <p><strong>Long Pauses:</strong> ${data.typingData.pausePatterns.longPauses}</p>
            <p><strong>Total Answer Changes:</strong> ${data.typingData.answerChanges.reduce((a,b) => a+b, 0)}</p>
            <p><strong>Instant Answers:</strong> ${data.typingData.instantAnswers}</p>
          </div>
        `;
      }

      modalContent.innerHTML = html;
    }

    function closeModal() {
      document.getElementById('detail-modal').style.display = 'none';
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('detail-modal');
      if (event.target === modal) {
        closeModal();
      }
    }

    // Load report on page load
    loadReport();

    // Refresh every 10 seconds
    setInterval(loadReport, 10000);
  </script>
</body>
</html>
