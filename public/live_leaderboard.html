<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Leaderboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #6c5ce7;
      --secondary: #00cec9;
      --success: #2ecc71;
      --danger: #e74c3c;
      --warning: #f39c12;
      --gold: #FFD700;
      --silver: #C0C0C0;
      --bronze: #CD7F32;
      --dark: #2d3436;
      --light: #dfe6e9;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 3em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .tabs {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 30px;
    }

    .tab-button {
      padding: 12px 30px;
      background: rgba(255,255,255,0.2);
      border: 2px solid white;
      color: white;
      font-size: 1.1em;
      font-weight: bold;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .tab-button:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
    }

    .tab-button.active {
      background: white;
      color: var(--primary);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .leaderboard-container {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    .podium {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 20px;
      margin-bottom: 40px;
      height: 300px;
    }

    .podium-place {
      flex: 1;
      max-width: 200px;
      text-align: center;
      animation: riseUp 0.8s ease;
    }

    @keyframes riseUp {
      from { transform: translateY(100px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .podium-place.first { animation-delay: 0.2s; }
    .podium-place.second { animation-delay: 0s; }
    .podium-place.third { animation-delay: 0.4s; }

    .podium-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin: 0 auto 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5em;
      border: 4px solid;
    }

    .podium-place.first .podium-avatar {
      background: linear-gradient(135deg, #FFD700, #FFA500);
      border-color: var(--gold);
    }

    .podium-place.second .podium-avatar {
      background: linear-gradient(135deg, #C0C0C0, #808080);
      border-color: var(--silver);
      width: 70px;
      height: 70px;
      font-size: 2em;
    }

    .podium-place.third .podium-avatar {
      background: linear-gradient(135deg, #CD7F32, #8B4513);
      border-color: var(--bronze);
      width: 70px;
      height: 70px;
      font-size: 2em;
    }

    .podium-name {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 5px;
      color: var(--dark);
    }

    .podium-score {
      font-size: 1.8em;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .podium-place.first .podium-score { color: var(--gold); }
    .podium-place.second .podium-score { color: var(--silver); }
    .podium-place.third .podium-score { color: var(--bronze); }

    .podium-xp {
      font-size: 0.9em;
      color: #666;
    }

    .podium-stand {
      background: linear-gradient(to top, #f0f0f0, #ffffff);
      border-radius: 10px 10px 0 0;
      padding: 20px;
      position: relative;
    }

    .podium-place.first .podium-stand {
      height: 180px;
      background: linear-gradient(to top, #FFD700, #FFF4E6);
    }

    .podium-place.second .podium-stand {
      height: 140px;
      background: linear-gradient(to top, #C0C0C0, #F0F0F0);
    }

    .podium-place.third .podium-stand {
      height: 100px;
      background: linear-gradient(to top, #CD7F32, #FFE4C4);
    }

    .rank-number {
      position: absolute;
      top: -40px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 3em;
      font-weight: bold;
    }

    .podium-place.first .rank-number { color: var(--gold); }
    .podium-place.second .rank-number { color: var(--silver); }
    .podium-place.third .rank-number { color: var(--bronze); }

    .leaderboard-list {
      margin-top: 40px;
    }

    .leaderboard-header {
      display: grid;
      grid-template-columns: 80px 1fr 150px 150px 150px;
      gap: 15px;
      padding: 15px 20px;
      background: var(--light);
      border-radius: 10px;
      font-weight: bold;
      color: var(--dark);
      margin-bottom: 10px;
    }

    .leaderboard-row {
      display: grid;
      grid-template-columns: 80px 1fr 150px 150px 150px;
      gap: 15px;
      padding: 15px 20px;
      background: white;
      border: 2px solid var(--light);
      border-radius: 10px;
      margin-bottom: 10px;
      align-items: center;
      transition: all 0.3s ease;
      animation: slideIn 0.5s ease;
    }

    @keyframes slideIn {
      from { transform: translateX(-50px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .leaderboard-row:hover {
      transform: translateX(5px);
      border-color: var(--primary);
      box-shadow: 0 5px 15px rgba(108, 92, 231, 0.2);
    }

    .rank {
      font-size: 1.5em;
      font-weight: bold;
      color: var(--primary);
      text-align: center;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5em;
      color: white;
    }

    .user-details {
      flex: 1;
    }

    .user-name {
      font-weight: bold;
      font-size: 1.1em;
      color: var(--dark);
    }

    .user-tier {
      font-size: 0.9em;
      color: #666;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .stat {
      text-align: center;
    }

    .stat-value {
      font-size: 1.3em;
      font-weight: bold;
      color: var(--primary);
    }

    .stat-label {
      font-size: 0.8em;
      color: #666;
      margin-top: 3px;
    }

    .badges {
      display: flex;
      gap: 5px;
      justify-content: center;
    }

    .badge {
      font-size: 1.5em;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .badge:hover {
      transform: scale(1.3);
    }

    .refresh-info {
      text-align: center;
      color: #666;
      margin-top: 20px;
      font-size: 0.9em;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
      font-size: 1.2em;
    }

    .no-data {
      text-align: center;
      padding: 40px;
      color: #666;
      font-size: 1.2em;
    }

    @media (max-width: 768px) {
      .podium {
        height: auto;
        flex-direction: column;
        align-items: center;
      }

      .podium-place {
        max-width: 100%;
      }

      .leaderboard-header,
      .leaderboard-row {
        grid-template-columns: 60px 1fr 100px;
        font-size: 0.9em;
      }

      .stat:nth-child(4),
      .stat:nth-child(5) {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üèÜ Live Leaderboard</h1>
      <p>See who's leading the competition!</p>
    </div>

    <div class="tabs">
      <button class="tab-button active" onclick="switchTab('quiz')">Current Quiz</button>
      <button class="tab-button" onclick="switchTab('global')">Global Rankings</button>
    </div>

    <div id="quiz-tab" class="tab-content active">
      <div class="leaderboard-container">
        <div id="quiz-leaderboard">
          <div class="loading">Loading current quiz leaderboard...</div>
        </div>
      </div>
    </div>

    <div id="global-tab" class="tab-content">
      <div class="leaderboard-container">
        <div id="global-leaderboard">
          <div class="loading">Loading global leaderboard...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentTab = 'quiz';
    let refreshInterval;

    function switchTab(tab) {
      currentTab = tab;

      // Update tab buttons
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`${tab}-tab`).classList.add('active');

      // Clear interval and fetch new data
      if (refreshInterval) {
        clearInterval(refreshInterval);
      }
      fetchLeaderboard();
      startAutoRefresh();
    }

    async function fetchQuizLeaderboard() {
      try {
        const response = await fetch('/api/leaderboard/quiz');
        if (!response.ok) {
          throw new Error('No active quiz');
        }
        const data = await response.json();
        displayQuizLeaderboard(data);
      } catch (error) {
        console.error('Error fetching quiz leaderboard:', error);
        document.getElementById('quiz-leaderboard').innerHTML = `
          <div class="no-data">
            <p>No active quiz at the moment</p>
            <p style="font-size: 0.9em; margin-top: 10px;">Start a quiz to see live rankings!</p>
          </div>
        `;
      }
    }

    async function fetchGlobalLeaderboard() {
      try {
        const response = await fetch('/api/leaderboard/global?limit=50');
        const data = await response.json();
        displayGlobalLeaderboard(data);
      } catch (error) {
        console.error('Error fetching global leaderboard:', error);
        document.getElementById('global-leaderboard').innerHTML = `
          <div class="no-data">Error loading leaderboard</div>
        `;
      }
    }

    function displayQuizLeaderboard(data) {
      const container = document.getElementById('quiz-leaderboard');

      if (!data.entries || data.entries.length === 0) {
        container.innerHTML = `
          <div class="no-data">
            <p>No submissions yet</p>
            <p style="font-size: 0.9em; margin-top: 10px;">Be the first to complete the quiz!</p>
          </div>
        `;
        return;
      }

      let html = '';

      // Show podium for top 3
      if (data.entries.length >= 3) {
        html += `<div class="podium">`;

        // Second place
        const second = data.entries[1];
        html += createPodiumPlace(second, 'second', 2);

        // First place
        const first = data.entries[0];
        html += createPodiumPlace(first, 'first', 1);

        // Third place
        const third = data.entries[2];
        html += createPodiumPlace(third, 'third', 3);

        html += `</div>`;
      }

      // Show full list
      html += `
        <div class="leaderboard-list">
          <div class="leaderboard-header">
            <div>Rank</div>
            <div>Participant</div>
            <div>Score</div>
            <div>Percentage</div>
            <div>Time</div>
          </div>
      `;

      data.entries.forEach((entry, index) => {
        html += `
          <div class="leaderboard-row" style="animation-delay: ${index * 0.05}s">
            <div class="rank">#${entry.rank}</div>
            <div class="user-info">
              <div class="user-avatar">${entry.userName.charAt(0).toUpperCase()}</div>
              <div class="user-details">
                <div class="user-name">${escapeHtml(entry.userName)}</div>
                ${entry.isTeam ? `<div class="user-tier">üë• Team: ${escapeHtml(entry.teamName)}</div>` : ''}
              </div>
            </div>
            <div class="stat">
              <div class="stat-value">${entry.score}</div>
              <div class="stat-label">points</div>
            </div>
            <div class="stat">
              <div class="stat-value">${entry.percentage}%</div>
              <div class="stat-label">accuracy</div>
            </div>
            <div class="stat">
              <div class="stat-value">${formatTime(entry.timeTaken)}</div>
              <div class="stat-label">time</div>
            </div>
          </div>
        `;
      });

      html += `
          </div>
          <div class="refresh-info">
            Updates automatically every 5 seconds ‚Ä¢ Last updated: ${new Date().toLocaleTimeString()}
          </div>
        `;

      container.innerHTML = html;
    }

    function displayGlobalLeaderboard(data) {
      const container = document.getElementById('global-leaderboard');

      if (!data || data.length === 0) {
        container.innerHTML = `
          <div class="no-data">
            <p>No rankings yet</p>
            <p style="font-size: 0.9em; margin-top: 10px;">Complete a quiz to appear on the leaderboard!</p>
          </div>
        `;
        return;
      }

      let html = '';

      // Show podium for top 3
      if (data.length >= 3) {
        html += `<div class="podium">`;

        // Second place
        html += createGlobalPodiumPlace(data[1], 'second', 2);

        // First place
        html += createGlobalPodiumPlace(data[0], 'first', 1);

        // Third place
        html += createGlobalPodiumPlace(data[2], 'third', 3);

        html += `</div>`;
      }

      // Show full list
      html += `
        <div class="leaderboard-list">
          <div class="leaderboard-header">
            <div>Rank</div>
            <div>Student</div>
            <div>XP</div>
            <div>Avg Score</div>
            <div>Quizzes</div>
          </div>
      `;

      data.forEach((entry, index) => {
        const tierInfo = getTierDisplay(entry.currentTier);
        html += `
          <div class="leaderboard-row" style="animation-delay: ${index * 0.05}s">
            <div class="rank">#${entry.rank}</div>
            <div class="user-info">
              <div class="user-avatar">${entry.userName.charAt(0).toUpperCase()}</div>
              <div class="user-details">
                <div class="user-name">${escapeHtml(entry.userName)}</div>
                <div class="user-tier">${tierInfo.icon} ${tierInfo.name}</div>
              </div>
            </div>
            <div class="stat">
              <div class="stat-value">${entry.totalXP.toLocaleString()}</div>
              <div class="stat-label">XP</div>
            </div>
            <div class="stat">
              <div class="stat-value">${entry.averageScore}%</div>
              <div class="stat-label">avg score</div>
            </div>
            <div class="badges">
              ${entry.recentAchievements.map(a => `<span class="badge" title="${a.name}">${a.icon}</span>`).join('')}
            </div>
          </div>
        `;
      });

      html += `
          </div>
          <div class="refresh-info">
            Updates automatically every 10 seconds ‚Ä¢ Last updated: ${new Date().toLocaleTimeString()}
          </div>
        `;

      container.innerHTML = html;
    }

    function createPodiumPlace(entry, position, rank) {
      return `
        <div class="podium-place ${position}">
          <div class="rank-number">${rank}</div>
          <div class="podium-avatar">${entry.userName.charAt(0).toUpperCase()}</div>
          <div class="podium-name">${escapeHtml(entry.userName)}</div>
          <div class="podium-score">${entry.percentage}%</div>
          <div class="podium-xp">${entry.score} points</div>
          <div class="podium-stand"></div>
        </div>
      `;
    }

    function createGlobalPodiumPlace(entry, position, rank) {
      const tierInfo = getTierDisplay(entry.currentTier);
      return `
        <div class="podium-place ${position}">
          <div class="rank-number">${rank}</div>
          <div class="podium-avatar">${entry.userName.charAt(0).toUpperCase()}</div>
          <div class="podium-name">${escapeHtml(entry.userName)}</div>
          <div class="podium-score">${entry.totalXP.toLocaleString()} XP</div>
          <div class="podium-xp">${tierInfo.icon} ${tierInfo.name}</div>
          <div class="podium-stand"></div>
        </div>
      `;
    }

    function getTierDisplay(tierId) {
      const tiers = {
        'beginner': { icon: 'üå±', name: 'Beginner' },
        'novice': { icon: 'üìñ', name: 'Novice' },
        'apprentice': { icon: 'üéØ', name: 'Apprentice' },
        'scholar': { icon: 'üìö', name: 'Scholar' },
        'expert': { icon: '‚≠ê', name: 'Expert' },
        'master': { icon: 'üèÖ', name: 'Master' },
        'grandmaster': { icon: 'üèÜ', name: 'Grandmaster' },
        'legend': { icon: 'üëë', name: 'Legend' }
      };
      return tiers[tierId] || { icon: 'üå±', name: 'Beginner' };
    }

    function formatTime(seconds) {
      if (!seconds) return 'N/A';
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function fetchLeaderboard() {
      if (currentTab === 'quiz') {
        fetchQuizLeaderboard();
      } else {
        fetchGlobalLeaderboard();
      }
    }

    function startAutoRefresh() {
      const interval = currentTab === 'quiz' ? 5000 : 10000; // Quiz: 5s, Global: 10s
      refreshInterval = setInterval(fetchLeaderboard, interval);
    }

    // Initial load
    fetchLeaderboard();
    startAutoRefresh();
  </script>
</body>
</html>
