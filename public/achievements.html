<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Achievements</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #6c5ce7;
      --secondary: #00cec9;
      --success: #2ecc71;
      --danger: #e74c3c;
      --warning: #f39c12;
      --gold: #FFD700;
      --dark: #2d3436;
      --light: #dfe6e9;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .profile-header {
      background: white;
      border-radius: 20px;
      padding: 40px;
      margin-bottom: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 30px;
    }

    .profile-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3em;
      color: white;
      font-weight: bold;
      box-shadow: 0 5px 20px rgba(108, 92, 231, 0.3);
    }

    .profile-info {
      flex: 1;
    }

    .profile-name {
      font-size: 2.5em;
      font-weight: bold;
      color: var(--dark);
      margin-bottom: 10px;
    }

    .profile-tier {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 10px 20px;
      border-radius: 25px;
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 20px;
    }

    .profile-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .stat-box {
      text-align: center;
    }

    .stat-value {
      font-size: 2em;
      font-weight: bold;
      color: var(--primary);
    }

    .stat-label {
      font-size: 0.9em;
      color: #666;
      margin-top: 5px;
    }

    .xp-progress-section {
      background: white;
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    .section-title {
      font-size: 1.8em;
      font-weight: bold;
      color: var(--dark);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .xp-bar-container {
      background: var(--light);
      height: 40px;
      border-radius: 20px;
      overflow: hidden;
      position: relative;
      margin-bottom: 15px;
    }

    .xp-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      transition: width 1s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }

    .xp-info {
      display: flex;
      justify-content: space-between;
      color: #666;
      font-size: 0.9em;
    }

    .tier-roadmap {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
      overflow-x: auto;
      padding: 10px 0;
    }

    .tier-item {
      text-align: center;
      min-width: 100px;
      padding: 15px;
      border-radius: 15px;
      background: var(--light);
      transition: all 0.3s ease;
    }

    .tier-item.current {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      transform: scale(1.1);
      box-shadow: 0 5px 20px rgba(108, 92, 231, 0.3);
    }

    .tier-item.completed {
      background: var(--success);
      color: white;
    }

    .tier-icon {
      font-size: 2em;
      margin-bottom: 5px;
    }

    .tier-name {
      font-size: 0.9em;
      font-weight: bold;
    }

    .achievements-section {
      background: white;
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    .achievement-filters {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 10px 20px;
      border: 2px solid var(--primary);
      background: white;
      color: var(--primary);
      border-radius: 20px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .filter-btn:hover,
    .filter-btn.active {
      background: var(--primary);
      color: white;
    }

    .achievements-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .achievement-card {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .achievement-card.unlocked {
      background: linear-gradient(135deg, #FAD961 0%, #F76B1C 100%);
      color: white;
      animation: glow 2s infinite;
    }

    @keyframes glow {
      0%, 100% { box-shadow: 0 0 20px rgba(247, 107, 28, 0.5); }
      50% { box-shadow: 0 0 40px rgba(247, 107, 28, 0.8); }
    }

    .achievement-card.locked {
      opacity: 0.6;
      filter: grayscale(0.5);
    }

    .achievement-icon {
      font-size: 4em;
      margin-bottom: 10px;
      filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.2));
    }

    .achievement-card.locked .achievement-icon {
      filter: grayscale(1) opacity(0.3);
    }

    .achievement-name {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .achievement-description {
      font-size: 0.9em;
      margin-bottom: 15px;
      opacity: 0.9;
    }

    .achievement-reward {
      display: inline-block;
      background: rgba(255,255,255,0.3);
      padding: 5px 15px;
      border-radius: 15px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .achievement-card.unlocked .achievement-reward {
      background: rgba(255,255,255,0.5);
    }

    .achievement-tier-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 5px 10px;
      border-radius: 10px;
      font-size: 0.8em;
      font-weight: bold;
    }

    .achievement-tier-badge.bronze { background: #CD7F32; color: white; }
    .achievement-tier-badge.silver { background: #C0C0C0; color: white; }
    .achievement-tier-badge.gold { background: #FFD700; color: #333; }
    .achievement-tier-badge.platinum { background: #E5E4E2; color: #333; }

    .achievement-progress {
      margin-top: 10px;
    }

    .progress-bar-small {
      height: 8px;
      background: rgba(0,0,0,0.2);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 5px;
    }

    .progress-fill {
      height: 100%;
      background: var(--success);
      transition: width 1s ease;
    }

    .progress-text {
      font-size: 0.8em;
      opacity: 0.8;
    }

    .unlock-badge {
      position: absolute;
      top: -10px;
      right: -10px;
      background: var(--success);
      color: white;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8em;
      font-weight: bold;
      transform: rotate(15deg);
      box-shadow: 0 3px 10px rgba(0,0,0,0.3);
    }

    .back-btn {
      display: inline-block;
      padding: 12px 30px;
      background: white;
      color: var(--primary);
      text-decoration: none;
      border-radius: 25px;
      font-weight: bold;
      margin-bottom: 20px;
      transition: all 0.3s ease;
    }

    .back-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .loading {
      text-align: center;
      padding: 40px;
      font-size: 1.2em;
      color: white;
    }

    @media (max-width: 768px) {
      .profile-header {
        flex-direction: column;
        text-align: center;
      }

      .profile-stats {
        grid-template-columns: repeat(2, 1fr);
      }

      .tier-roadmap {
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="/" class="back-btn">‚Üê Back to Quiz</a>

    <div id="profile-container" class="loading">
      Loading your profile...
    </div>

    <div id="xp-section" style="display: none;"></div>
    <div id="achievements-section" style="display: none;"></div>
  </div>

  <script>
    const userId = localStorage.getItem('participantId');
    const userName = localStorage.getItem('participantName') || 'Student';

    if (!userId) {
      document.getElementById('profile-container').innerHTML = `
        <div style="background: white; border-radius: 20px; padding: 40px; text-align: center;">
          <h2 style="color: var(--dark); margin-bottom: 20px;">Welcome!</h2>
          <p style="color: #666; margin-bottom: 20px;">You need to complete a quiz first to see your achievements.</p>
          <a href="/" class="back-btn">Start a Quiz</a>
        </div>
      `;
    } else {
      loadUserData();
    }

    async function loadUserData() {
      try {
        const [statsResponse, progressResponse] = await Promise.all([
          fetch(`/api/achievements/user/${userId}`),
          fetch(`/api/achievements/progress/${userId}`)
        ]);

        if (!statsResponse.ok) {
          throw new Error('Failed to load user data');
        }

        const stats = await statsResponse.json();
        const progress = await progressResponse.json();

        displayProfile(stats);
        displayXPProgress(stats);
        displayAchievements(progress);
      } catch (error) {
        console.error('Error loading user data:', error);
        document.getElementById('profile-container').innerHTML = `
          <div style="background: white; border-radius: 20px; padding: 40px; text-align: center; color: var(--danger);">
            <h2>Error loading profile</h2>
            <p>Please try again later.</p>
          </div>
        `;
      }
    }

    function displayProfile(stats) {
      const { profile, tier, rank } = stats;

      const html = `
        <div class="profile-header">
          <div class="profile-avatar">${userName.charAt(0).toUpperCase()}</div>
          <div class="profile-info">
            <div class="profile-name">${escapeHtml(userName)}</div>
            <div class="profile-tier">
              <span>${tier.icon}</span>
              <span>${tier.name}</span>
            </div>
            <div class="profile-stats">
              <div class="stat-box">
                <div class="stat-value">${profile.totalXP.toLocaleString()}</div>
                <div class="stat-label">Total XP</div>
              </div>
              <div class="stat-box">
                <div class="stat-value">#${rank || 'N/A'}</div>
                <div class="stat-label">Global Rank</div>
              </div>
              <div class="stat-box">
                <div class="stat-value">${profile.quizzesCompleted}</div>
                <div class="stat-label">Quizzes Completed</div>
              </div>
              <div class="stat-box">
                <div class="stat-value">${profile.averageScore}%</div>
                <div class="stat-label">Average Score</div>
              </div>
              <div class="stat-box">
                <div class="stat-value">${profile.bestScore}%</div>
                <div class="stat-label">Best Score</div>
              </div>
              <div class="stat-box">
                <div class="stat-value">${profile.currentStreak}</div>
                <div class="stat-label">Current Streak</div>
              </div>
            </div>
          </div>
        </div>
      `;

      document.getElementById('profile-container').innerHTML = html;
    }

    function displayXPProgress(stats) {
      const { profile, tier, nextTier, xpToNextTier } = stats;

      let progressHtml = `
        <div class="xp-progress-section">
          <div class="section-title">
            <span>‚≠ê</span>
            <span>XP Progress</span>
          </div>
      `;

      if (nextTier) {
        const currentTierXP = tier.minXP;
        const nextTierXP = nextTier.minXP;
        const progress = ((profile.totalXP - currentTierXP) / (nextTierXP - currentTierXP)) * 100;

        progressHtml += `
          <div class="xp-bar-container">
            <div class="xp-bar" style="width: ${progress}%">
              ${Math.round(progress)}%
            </div>
          </div>
          <div class="xp-info">
            <span>${tier.icon} ${tier.name}</span>
            <span>${xpToNextTier.toLocaleString()} XP to ${nextTier.icon} ${nextTier.name}</span>
          </div>
        `;
      } else {
        progressHtml += `
          <div class="xp-bar-container">
            <div class="xp-bar" style="width: 100%">
              MAX LEVEL!
            </div>
          </div>
          <div class="xp-info">
            <span>${tier.icon} ${tier.name} - Maximum Rank!</span>
          </div>
        `;
      }

      // Tier roadmap
      progressHtml += `<div class="tier-roadmap">`;

      const tiers = [
        { id: 'beginner', icon: 'üå±', name: 'Beginner', minXP: 0 },
        { id: 'novice', icon: 'üìñ', name: 'Novice', minXP: 500 },
        { id: 'apprentice', icon: 'üéØ', name: 'Apprentice', minXP: 1000 },
        { id: 'scholar', icon: 'üìö', name: 'Scholar', minXP: 2000 },
        { id: 'expert', icon: '‚≠ê', name: 'Expert', minXP: 3500 },
        { id: 'master', icon: 'üèÖ', name: 'Master', minXP: 5500 },
        { id: 'grandmaster', icon: 'üèÜ', name: 'Grandmaster', minXP: 8000 },
        { id: 'legend', icon: 'üëë', name: 'Legend', minXP: 12000 }
      ];

      tiers.forEach(t => {
        let className = 'tier-item';
        if (t.id === tier.id) {
          className += ' current';
        } else if (profile.totalXP >= t.minXP) {
          className += ' completed';
        }

        progressHtml += `
          <div class="${className}">
            <div class="tier-icon">${t.icon}</div>
            <div class="tier-name">${t.name}</div>
          </div>
        `;
      });

      progressHtml += `</div></div>`;

      document.getElementById('xp-section').innerHTML = progressHtml;
      document.getElementById('xp-section').style.display = 'block';
    }

    function displayAchievements(achievementProgress) {
      const unlocked = achievementProgress.filter(a => a.unlocked);
      const locked = achievementProgress.filter(a => !a.unlocked);

      let html = `
        <div class="achievements-section">
          <div class="section-title">
            <span>üèÜ</span>
            <span>Achievements (${unlocked.length}/${achievementProgress.length})</span>
          </div>

          <div class="achievement-filters">
            <button class="filter-btn active" onclick="filterAchievements('all')">All</button>
            <button class="filter-btn" onclick="filterAchievements('unlocked')">Unlocked (${unlocked.length})</button>
            <button class="filter-btn" onclick="filterAchievements('locked')">Locked (${locked.length})</button>
            <button class="filter-btn" onclick="filterAchievements('bronze')">Bronze</button>
            <button class="filter-btn" onclick="filterAchievements('silver')">Silver</button>
            <button class="filter-btn" onclick="filterAchievements('gold')">Gold</button>
            <button class="filter-btn" onclick="filterAchievements('platinum')">Platinum</button>
          </div>

          <div class="achievements-grid">
      `;

      achievementProgress.forEach(achievement => {
        const cardClass = achievement.unlocked ? 'achievement-card unlocked' : 'achievement-card locked';
        const tierClass = achievement.tier;

        html += `
          <div class="${cardClass}" data-filter="${achievement.unlocked ? 'unlocked' : 'locked'} ${tierClass}">
            ${achievement.unlocked ? '<div class="unlock-badge">‚úì UNLOCKED</div>' : ''}
            <div class="achievement-tier-badge ${tierClass}">${tierClass.toUpperCase()}</div>
            <div class="achievement-icon">${achievement.icon}</div>
            <div class="achievement-name">${achievement.name}</div>
            <div class="achievement-description">${achievement.description}</div>
            <div class="achievement-reward">+${achievement.xpReward} XP</div>
        `;

        if (!achievement.unlocked && achievement.percentage > 0) {
          html += `
            <div class="achievement-progress">
              <div class="progress-bar-small">
                <div class="progress-fill" style="width: ${achievement.percentage}%"></div>
              </div>
              <div class="progress-text">${achievement.currentValue}/${achievement.targetValue}</div>
            </div>
          `;
        }

        html += `</div>`;
      });

      html += `</div></div>`;

      document.getElementById('achievements-section').innerHTML = html;
      document.getElementById('achievements-section').style.display = 'block';
    }

    function filterAchievements(filter) {
      // Update button states
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      // Filter cards
      document.querySelectorAll('.achievement-card').forEach(card => {
        const filters = card.getAttribute('data-filter');
        if (filter === 'all' || filters.includes(filter)) {
          card.style.display = 'block';
        } else {
          card.style.display = 'none';
        }
      });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
