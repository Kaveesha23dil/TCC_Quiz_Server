<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Team Quiz</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

    :root {
      --primary: #6c5ce7;
      --primary-hover: #5649c0;
      --secondary: #00cec9;
      --danger: #e74c3c;
      --danger-hover: #c0392b;
      --success: #2ecc71;
      --warning: #f39c12;
      --light: #f8f9fa;
      --dark: #2d3436;
      --gray: #dfe6e9;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 2rem;
      color: var(--dark);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .card {
      background: white;
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      margin-bottom: 2rem;
      animation: fadeInUp 0.5s;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    h1, h2, h3 {
      color: var(--primary);
      margin-bottom: 1rem;
    }

    h1 {
      text-align: center;
      font-size: 2.5rem;
      margin-bottom: 2rem;
    }

    .btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      font-family: inherit;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn:hover {
      background: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3);
    }

    .btn-success {
      background: var(--success);
    }

    .btn-success:hover {
      background: #27ae60;
      box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
    }

    .btn-danger {
      background: var(--danger);
    }

    .btn-danger:hover {
      background: var(--danger-hover);
      box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
    }

    .btn-secondary {
      background: var(--secondary);
    }

    .btn-secondary:hover {
      background: #00b3a8;
      box-shadow: 0 5px 15px rgba(0, 206, 201, 0.3);
    }

    input, select, textarea {
      width: 100%;
      padding: 0.8rem 1rem;
      margin-top: 0.5rem;
      margin-bottom: 1rem;
      border: 2px solid var(--gray);
      border-radius: 10px;
      font-family: inherit;
      font-size: 1rem;
      transition: all 0.3s;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.2);
    }

    label {
      display: block;
      font-weight: 500;
      margin-top: 0.5rem;
      color: var(--dark);
    }

    .team-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-top: 1.5rem;
    }

    .team-card {
      background: var(--light);
      padding: 1.5rem;
      border-radius: 12px;
      border-left: 4px solid var(--primary);
      transition: all 0.3s;
    }

    .team-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .team-card h3 {
      color: var(--primary);
      margin-bottom: 0.8rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .team-info {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 0.5rem;
    }

    .team-members {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 1rem;
      margin-bottom: 1rem;
    }

    .member-badge {
      background: var(--primary);
      color: white;
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .leader-badge {
      background: var(--warning);
    }

    .status-badge {
      display: inline-block;
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .status-waiting {
      background: #fff3cd;
      color: #856404;
    }

    .status-in-progress {
      background: #d1ecf1;
      color: #0c5460;
    }

    .status-completed {
      background: #d4edda;
      color: #155724;
    }

    .quiz-section {
      margin-top: 2rem;
    }

    .question {
      background: var(--light);
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      border-left: 4px solid var(--primary);
      position: relative;
    }

    .question h3 {
      margin-bottom: 1rem;
    }

    .option-label {
      display: flex;
      align-items: center;
      padding: 0.8rem 1rem;
      margin: 0.5rem 0;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }

    .option-label:hover {
      background: rgba(108, 92, 231, 0.1);
      border-color: var(--primary);
    }

    .option-label.selected {
      background: rgba(108, 92, 231, 0.2);
      border-color: var(--primary);
    }

    .radio-custom, .checkbox-custom {
      appearance: none;
      width: 20px;
      height: 20px;
      border: 2px solid var(--primary);
      border-radius: 50%;
      margin-right: 10px;
      position: relative;
      cursor: pointer;
    }

    .checkbox-custom {
      border-radius: 4px;
    }

    .radio-custom:checked::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 10px;
      height: 10px;
      background: var(--primary);
      border-radius: 50%;
    }

    .checkbox-custom:checked {
      background: var(--primary);
    }

    .checkbox-custom:checked::after {
      content: '‚úì';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 14px;
      font-weight: bold;
    }

    .answered-by {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: var(--success);
      color: white;
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .progress-container {
      background: var(--light);
      border-radius: 10px;
      height: 20px;
      overflow: hidden;
      margin: 1rem 0;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(to right, var(--secondary), var(--primary));
      transition: width 0.5s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .alert {
      padding: 1rem 1.5rem;
      border-radius: 10px;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border-left: 4px solid var(--success);
    }

    .alert-danger {
      background: #f8d7da;
      color: #721c24;
      border-left: 4px solid var(--danger);
    }

    .alert-info {
      background: #d1ecf1;
      color: #0c5460;
      border-left: 4px solid #17a2b8;
    }

    .hidden {
      display: none !important;
    }

    .team-lobby {
      text-align: center;
    }

    .waiting-animation {
      font-size: 2rem;
      margin: 2rem 0;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .back-btn {
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 100;
    }
  </style>
</head>
<body>
  <button class="btn btn-secondary back-btn" onclick="window.location.href='admin_welcome.html'">
    <i class="fas fa-arrow-left"></i> Back to Home
  </button>

  <div class="container">
    <h1><i class="fas fa-users"></i> Team Quiz Mode</h1>

    <!-- Step 1: Enter Name -->
    <div id="name-section" class="card">
      <h2><i class="fas fa-user"></i> Enter Your Name</h2>
      <label for="student-name">Your Name:</label>
      <input type="text" id="student-name" placeholder="Enter your full name" required>
      <button class="btn" onclick="setName()">
        <i class="fas fa-check"></i> Continue
      </button>
    </div>

    <!-- Step 2: Create or Join Team -->
    <div id="team-selection" class="card hidden">
      <h2><i class="fas fa-users-cog"></i> Create or Join a Team</h2>

      <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
        <button class="btn" onclick="showCreateTeam()">
          <i class="fas fa-plus"></i> Create New Team
        </button>
        <button class="btn btn-secondary" onclick="refreshTeams()">
          <i class="fas fa-sync"></i> Refresh Teams
        </button>
      </div>

      <!-- Create Team Form -->
      <div id="create-team-form" class="hidden">
        <h3><i class="fas fa-flag"></i> Create New Team</h3>
        <label for="team-name">Team Name:</label>
        <input type="text" id="team-name" placeholder="Enter team name">

        <label for="max-members">Maximum Members (2-8):</label>
        <select id="max-members">
          <option value="2">2 Members</option>
          <option value="3">3 Members</option>
          <option value="4" selected>4 Members</option>
          <option value="5">5 Members</option>
          <option value="6">6 Members</option>
          <option value="7">7 Members</option>
          <option value="8">8 Members</option>
        </select>

        <button class="btn btn-success" onclick="createTeam()">
          <i class="fas fa-check-circle"></i> Create Team
        </button>
        <button class="btn btn-secondary" onclick="hideCreateTeam()">
          <i class="fas fa-times"></i> Cancel
        </button>
      </div>

      <!-- Available Teams -->
      <div id="teams-list">
        <h3><i class="fas fa-list"></i> Available Teams</h3>
        <div id="teams-container" class="team-grid"></div>
      </div>
    </div>

    <!-- Step 3: Team Lobby -->
    <div id="team-lobby" class="card hidden">
      <div class="team-lobby">
        <h2><i class="fas fa-users"></i> Team: <span id="lobby-team-name"></span></h2>

        <div class="status-section" style="margin: 2rem 0;">
          <div class="team-members" id="lobby-members" style="justify-content: center;"></div>
        </div>

        <div id="waiting-for-quiz" class="hidden">
          <div class="waiting-animation">
            <i class="fas fa-hourglass-half"></i>
          </div>
          <p style="font-size: 1.2rem; color: #666;">Waiting for quiz to start...</p>
          <p style="color: #999; margin-top: 0.5rem;">The admin will start the quiz soon</p>
        </div>

        <button class="btn btn-danger" onclick="leaveTeam()" style="margin-top: 2rem;">
          <i class="fas fa-sign-out-alt"></i> Leave Team
        </button>
      </div>
    </div>

    <!-- Step 4: Quiz Section -->
    <div id="quiz-section" class="card hidden">
      <h2><i class="fas fa-brain"></i> Quiz: <span id="quiz-title"></span></h2>
      <div class="alert alert-info">
        <i class="fas fa-info-circle"></i>
        <span>Team Mode: All team members can see and change answers. Collaborate to get the best score!</span>
      </div>

      <div class="progress-container">
        <div class="progress-bar" id="quiz-progress">0%</div>
      </div>

      <div id="quiz-content" class="quiz-section"></div>

      <button class="btn btn-success" onclick="submitTeamQuiz()" style="margin-top: 2rem;">
        <i class="fas fa-paper-plane"></i> Submit Team Answers
      </button>
    </div>

    <!-- Results Section -->
    <div id="results-section" class="card hidden">
      <h2><i class="fas fa-trophy"></i> Team Results</h2>
      <div id="results-content"></div>
      <button class="btn" onclick="location.reload()" style="margin-top: 2rem;">
        <i class="fas fa-redo"></i> Start New Session
      </button>
    </div>
  </div>

  <script>
    let studentName = '';
    let participantId = '';
    let currentTeam = null;
    let quizData = null;
    let refreshInterval = null;

    // Step 1: Set Name
    function setName() {
      const name = document.getElementById('student-name').value.trim();
      if (!name) {
        alert('Please enter your name');
        return;
      }

      studentName = name;
      participantId = generateId();

      document.getElementById('name-section').classList.add('hidden');
      document.getElementById('team-selection').classList.remove('hidden');

      refreshTeams();
      startAutoRefresh();
    }

    // Generate unique ID
    function generateId() {
      return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // Show/Hide Create Team Form
    function showCreateTeam() {
      document.getElementById('create-team-form').classList.remove('hidden');
    }

    function hideCreateTeam() {
      document.getElementById('create-team-form').classList.add('hidden');
    }

    // Create Team
    async function createTeam() {
      const teamName = document.getElementById('team-name').value.trim();
      const maxMembers = document.getElementById('max-members').value;

      if (!teamName) {
        alert('Please enter a team name');
        return;
      }

      try {
        const res = await fetch('/api/teams/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            teamName,
            creatorId: participantId,
            creatorName: studentName,
            maxMembers: parseInt(maxMembers)
          })
        });

        const data = await res.json();

        if (!res.ok) {
          alert(data.message || 'Failed to create team');
          return;
        }

        currentTeam = data.team;

        // Play success sound
        soundManager.playStart();

        showTeamLobby();
      } catch (error) {
        alert('Error creating team: ' + error.message);
      }
    }

    // Refresh Teams List
    async function refreshTeams() {
      try {
        const res = await fetch('/api/teams');
        const teams = await res.json();

        const container = document.getElementById('teams-container');

        if (teams.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No teams available. Create one!</p>';
          return;
        }

        container.innerHTML = teams.map(team => `
          <div class="team-card">
            <h3><i class="fas fa-users"></i> ${team.name}</h3>
            <div class="team-info">
              <i class="fas fa-user-friends"></i> ${team.currentMembers}/${team.maxMembers} Members
            </div>
            <div class="team-info">
              <span class="status-badge status-${team.status}">${team.status.replace('_', ' ')}</span>
            </div>
            <div class="team-members">
              ${team.members.map(m => `
                <span class="member-badge ${m.role === 'leader' ? 'leader-badge' : ''}">
                  <i class="fas fa-${m.role === 'leader' ? 'crown' : 'user'}"></i> ${m.name}
                </span>
              `).join('')}
            </div>
            ${team.canJoin ? `
              <button class="btn btn-success" onclick="joinTeam('${team.id}')">
                <i class="fas fa-sign-in-alt"></i> Join Team
              </button>
            ` : `
              <button class="btn" disabled style="opacity: 0.5; cursor: not-allowed;">
                <i class="fas fa-lock"></i> ${team.status !== 'waiting' ? 'Quiz Started' : 'Team Full'}
              </button>
            `}
          </div>
        `).join('');
      } catch (error) {
        console.error('Error fetching teams:', error);
      }
    }

    // Join Team
    async function joinTeam(teamId) {
      try {
        const res = await fetch('/api/teams/join', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            teamId,
            memberId: participantId,
            memberName: studentName
          })
        });

        const data = await res.json();

        if (!res.ok) {
          alert(data.message || 'Failed to join team');
          return;
        }

        currentTeam = data.team;

        // Play success sound
        soundManager.playStart();

        showTeamLobby();
      } catch (error) {
        alert('Error joining team: ' + error.message);
      }
    }

    // Leave Team
    async function leaveTeam() {
      if (!confirm('Are you sure you want to leave the team?')) {
        return;
      }

      try {
        const res = await fetch('/api/teams/leave', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            teamId: currentTeam.id,
            memberId: participantId
          })
        });

        const data = await res.json();

        if (data.teamDissolved) {
          alert('Team was dissolved');
        }

        currentTeam = null;
        document.getElementById('team-lobby').classList.add('hidden');
        document.getElementById('team-selection').classList.remove('hidden');
        refreshTeams();
      } catch (error) {
        alert('Error leaving team: ' + error.message);
      }
    }

    // Show Team Lobby
    function showTeamLobby() {
      document.getElementById('team-selection').classList.add('hidden');
      document.getElementById('team-lobby').classList.remove('hidden');
      document.getElementById('lobby-team-name').textContent = currentTeam.name;
      document.getElementById('waiting-for-quiz').classList.remove('hidden');

      updateLobbyMembers();
      startQuizPolling();
    }

    // Update Lobby Members Display
    function updateLobbyMembers() {
      const container = document.getElementById('lobby-members');
      container.innerHTML = currentTeam.members.map(m => `
        <span class="member-badge ${m.role === 'leader' ? 'leader-badge' : ''}">
          <i class="fas fa-${m.role === 'leader' ? 'crown' : 'user'}"></i> ${m.name}
        </span>
      `).join('');
    }

    // Start Quiz Polling
    function startQuizPolling() {
      checkForQuiz();
      refreshInterval = setInterval(checkForQuiz, 3000);
    }

    // Check for Quiz
    async function checkForQuiz() {
      try {
        // Refresh team data
        const teamRes = await fetch(`/api/teams/${currentTeam.id}`);
        if (teamRes.ok) {
          currentTeam = await teamRes.json();
          updateLobbyMembers();
        }

        // Check for quiz
        const quizRes = await fetch('/api/currentQuiz');
        if (quizRes.ok) {
          const quiz = await quizRes.json();
          if (quiz.questions && !quizData) {
            quizData = quiz;
            clearInterval(refreshInterval);
            startTeamQuiz();
          }
        }
      } catch (error) {
        console.error('Error checking for quiz:', error);
      }
    }

    // Start Team Quiz
    async function startTeamQuiz() {
      document.getElementById('team-lobby').classList.add('hidden');
      document.getElementById('quiz-section').classList.remove('hidden');
      document.getElementById('quiz-title').textContent = quizData.name;

      // Play quiz start sound
      soundManager.playStart();

      renderQuiz();
      startTeamSyncInterval();

      // Update team status
      await fetch('/api/teams/update-progress', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          teamId: currentTeam.id,
          totalQuestions: quizData.questions.length,
          status: 'in_progress'
        })
      });
    }

    // Render Quiz
    function renderQuiz() {
      const container = document.getElementById('quiz-content');
      container.innerHTML = '';

      quizData.questions.forEach((q, idx) => {
        const qDiv = document.createElement('div');
        qDiv.className = 'question';
        qDiv.dataset.questionIndex = idx;

        let questionHTML = `<h3><i class="fas fa-question-circle"></i> Question ${idx + 1}</h3>`;
        questionHTML += `<p style="font-size: 1.1rem; margin-bottom: 1rem;">${q.question}</p>`;

        // Image-based question
        if (q.type === 'image-based' && q.image) {
          questionHTML += `<div style="text-align: center; margin: 1rem 0;">
            <img src="${q.image}" style="max-width: 100%; max-height: 300px; border-radius: 8px;">
          </div>`;
        }

        // Render based on question type
        switch(q.type) {
          case 'true-false':
            questionHTML += `
              <div class="options-container">
                <label class="option-label">
                  <input type="radio" name="q${idx}" value="true" class="radio-custom" onchange="updateTeamAnswer(${idx}, 'true')">
                  <span>True</span>
                </label>
                <label class="option-label">
                  <input type="radio" name="q${idx}" value="false" class="radio-custom" onchange="updateTeamAnswer(${idx}, 'false')">
                  <span>False</span>
                </label>
              </div>
            `;
            break;

          case 'multiple-answer':
            questionHTML += '<div class="options-container">';
            Object.keys(q.options).forEach(key => {
              questionHTML += `
                <label class="option-label">
                  <input type="checkbox" name="q${idx}" value="${key}" class="checkbox-custom" onchange="updateTeamAnswerMultiple(${idx})">
                  <span>${key}) ${q.options[key]}</span>
                </label>
              `;
            });
            questionHTML += '</div>';
            break;

          case 'fill-blank':
            questionHTML += `
              <input type="text" name="q${idx}" placeholder="Type your answer"
                onchange="updateTeamAnswer(${idx}, this.value)" style="margin-top: 1rem;">
            `;
            break;

          case 'short-answer':
            questionHTML += `
              <textarea name="q${idx}" rows="4" placeholder="Type your answer (will be manually graded)"
                onchange="updateTeamAnswer(${idx}, this.value)" style="margin-top: 1rem;"></textarea>
            `;
            break;

          default: // multiple-choice, image-based
            questionHTML += '<div class="options-container">';
            Object.keys(q.options).forEach(key => {
              let optionHTML = `
                <label class="option-label">
                  <input type="radio" name="q${idx}" value="${key}" class="radio-custom" onchange="updateTeamAnswer(${idx}, '${key}')">
                  <span>${key}) ${q.options[key]}</span>`;

              if (q.optionImages && q.optionImages[key]) {
                optionHTML += `<br><img src="${q.optionImages[key]}" style="max-width: 150px; margin-top: 0.5rem; border-radius: 4px;">`;
              }

              optionHTML += `</label>`;
              questionHTML += optionHTML;
            });
            questionHTML += '</div>';
            break;
        }

        qDiv.innerHTML = questionHTML;
        container.appendChild(qDiv);
      });

      // Load existing team answers
      loadTeamAnswers();
    }

    // Update Team Answer
    async function updateTeamAnswer(questionIndex, answer) {
      try {
        // Play click sound
        soundManager.playClick();

        await fetch('/api/teams/update-answer', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            teamId: currentTeam.id,
            questionIndex,
            answer,
            memberId: participantId,
            memberName: studentName
          })
        });

        showAnsweredBy(questionIndex, studentName);
        updateProgress();
      } catch (error) {
        console.error('Error updating answer:', error);
      }
    }

    // Update Multiple Answer
    async function updateTeamAnswerMultiple(questionIndex) {
      const checkboxes = document.querySelectorAll(`input[name="q${questionIndex}"]:checked`);
      const answer = Array.from(checkboxes).map(cb => cb.value);

      try {
        // Play click sound
        soundManager.playClick();

        await fetch('/api/teams/update-answer', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            teamId: currentTeam.id,
            questionIndex,
            answer,
            memberId: participantId,
            memberName: studentName
          })
        });

        showAnsweredBy(questionIndex, studentName);
        updateProgress();
      } catch (error) {
        console.error('Error updating answer:', error);
      }
    }

    // Show who answered
    function showAnsweredBy(questionIndex, memberName) {
      const qDiv = document.querySelector(`[data-question-index="${questionIndex}"]`);
      let badge = qDiv.querySelector('.answered-by');

      if (!badge) {
        badge = document.createElement('div');
        badge.className = 'answered-by';
        qDiv.appendChild(badge);
      }

      badge.innerHTML = `<i class="fas fa-user-check"></i> ${memberName}`;
    }

    // Start Team Sync
    function startTeamSyncInterval() {
      setInterval(async () => {
        try {
          const res = await fetch(`/api/teams/${currentTeam.id}`);
          if (res.ok) {
            const updatedTeam = await res.json();
            currentTeam = updatedTeam;
            loadTeamAnswers();
          }
        } catch (error) {
          console.error('Error syncing team data:', error);
        }
      }, 2000);
    }

    // Load Team Answers
    function loadTeamAnswers() {
      if (!currentTeam.answers) return;

      Object.keys(currentTeam.answers).forEach(qIdx => {
        const answerData = currentTeam.answers[qIdx];
        const answer = answerData.answer;
        const answeredBy = answerData.answeredBy;

        // Set the answer in the UI
        const qDiv = document.querySelector(`[data-question-index="${qIdx}"]`);
        if (!qDiv) return;

        const qType = quizData.questions[qIdx].type;

        if (qType === 'multiple-choice' || qType === 'true-false' || qType === 'image-based') {
          const radio = qDiv.querySelector(`input[value="${answer}"]`);
          if (radio) {
            radio.checked = true;
            radio.closest('.option-label').classList.add('selected');
          }
        } else if (qType === 'multiple-answer') {
          if (Array.isArray(answer)) {
            answer.forEach(val => {
              const checkbox = qDiv.querySelector(`input[value="${val}"]`);
              if (checkbox) {
                checkbox.checked = true;
                checkbox.closest('.option-label').classList.add('selected');
              }
            });
          }
        } else if (qType === 'fill-blank' || qType === 'short-answer') {
          const input = qDiv.querySelector('input, textarea');
          if (input) input.value = answer;
        }

        showAnsweredBy(qIdx, answeredBy);
      });

      updateProgress();
    }

    // Update Progress
    function updateProgress() {
      const totalQuestions = quizData.questions.length;
      const answeredCount = Object.keys(currentTeam.answers || {}).length;
      const percentage = (answeredCount / totalQuestions * 100).toFixed(0);

      const progressBar = document.getElementById('quiz-progress');
      progressBar.style.width = percentage + '%';
      progressBar.textContent = percentage + '%';

      // Update server
      fetch('/api/teams/update-progress', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          teamId: currentTeam.id,
          totalQuestions,
          answeredCount,
          progressPercentage: parseInt(percentage)
        })
      });
    }

    // Submit Team Quiz
    async function submitTeamQuiz() {
      const unanswered = quizData.questions.length - Object.keys(currentTeam.answers || {}).length;

      if (unanswered > 0) {
        if (!confirm(`Your team has ${unanswered} unanswered question(s). Submit anyway?`)) {
          return;
        }
      }

      if (!confirm('Submit team answers? This cannot be undone.')) {
        return;
      }

      // Play alert sound
      soundManager.playAlert();

      try {
        const res = await fetch('/api/teams/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            teamId: currentTeam.id
          })
        });

        const result = await res.json();

        if (!res.ok) {
          alert('Failed to submit: ' + result.message);
          return;
        }

        showResults(result);
      } catch (error) {
        alert('Error submitting quiz: ' + error.message);
      }
    }

    // Show Results
    function showResults(result) {
      document.getElementById('quiz-section').classList.add('hidden');
      document.getElementById('results-section').classList.remove('hidden');

      const percentage = result.totalPoints > 0 ? (result.score / result.totalPoints * 100).toFixed(1) : 0;

      // Play achievement sound based on team score
      setTimeout(() => {
        soundManager.playAchievement(percentage);
      }, 500);

      let emoji, message;
      if (percentage >= 90) {
        emoji = 'üèÜ';
        message = 'Outstanding Team Performance!';
      } else if (percentage >= 70) {
        emoji = 'üéâ';
        message = 'Great Teamwork!';
      } else if (percentage >= 50) {
        emoji = 'üëç';
        message = 'Good Team Effort!';
      } else {
        emoji = 'üìö';
        message = 'Keep Practicing Together!';
      }

      document.getElementById('results-content').innerHTML = `
        <div style="text-align: center; padding: 2rem;">
          <h2 style="font-size: 3rem;">${emoji} ${message}</h2>
          <div style="font-size: 2rem; margin: 2rem 0;">
            <strong>Team Score: ${result.score} / ${result.totalPoints}</strong>
          </div>
          <div style="font-size: 1.5rem; color: var(--primary);">
            ${percentage}%
          </div>
          ${result.manualGradingNeeded ? `
            <div class="alert alert-info" style="margin-top: 2rem;">
              <i class="fas fa-info-circle"></i>
              <span>Some questions require manual grading. Your final score may change.</span>
            </div>
          ` : ''}
        </div>
      `;
    }

    // Auto Refresh Teams
    function startAutoRefresh() {
      setInterval(() => {
        if (!document.getElementById('team-selection').classList.contains('hidden')) {
          refreshTeams();
        }
      }, 5000);
    }
  </script>

  <!-- Sound Manager -->
  <script src="sounds/sound-manager.js"></script>
</body>
</html>
